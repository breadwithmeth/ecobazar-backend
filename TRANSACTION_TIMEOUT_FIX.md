# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ —Ç–∞–π–º–∞—É—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ Prisma

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
```
Transaction API error: Transaction already closed: A batch query cannot be executed on an expired transaction. The timeout for this transaction was 5000 ms, however 5241 ms passed since the start of the transaction.
```

## –ü—Ä–∏—á–∏–Ω–∞
1. **–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π** –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
2. **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ** –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤–º–µ—Å—Ç–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ
3. **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ç–∞–π–º–∞—É—Ç** Prisma (5 —Å–µ–∫—É–Ω–¥) –±—ã–ª –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –£–≤–µ–ª–∏—á–µ–Ω —Ç–∞–π–º–∞—É—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
**–§–∞–π–ª—ã:** `src/controllers/orderController.ts`, `src/services/orderService.ts`

```typescript
const result = await prisma.$transaction(async (tx) => {
  // ... –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
}, {
  timeout: 15000 // –£–≤–µ–ª–∏—á–∏–ª–∏ —Å 5000ms –¥–æ 15000ms (15 —Å–µ–∫—É–Ω–¥)
});
```

### 2. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
**–í orderController.ts:**

**–î–æ (–º–µ–¥–ª–µ–Ω–Ω–æ):**
```typescript
// –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
const productsWithStores = await tx.product.findMany(...);

await Promise.all(
  order.items.map(async (orderItem: any) => {
    // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
  })
);

await Promise.all(
  items.map((item: any) =>
    // –°–æ–∑–¥–∞–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏–π —Å–∫–ª–∞–¥–∞
  )
);
```

**–ü–æ—Å–ª–µ (–±—ã—Å—Ç—Ä–æ):**
```typescript
// –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
const [productsWithStores] = await Promise.all([
  tx.product.findMany(...)
]);

await Promise.all([
  // –°–æ–∑–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ –¥–≤–∏–∂–µ–Ω–∏—è —Å–∫–ª–∞–¥–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
  ...order.items.map(async (orderItem: any) => {
    // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
  }),
  ...items.map((item: any) =>
    // –°–æ–∑–¥–∞–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏–π —Å–∫–ª–∞–¥–∞
  )
]);
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –º–∞–≥–∞–∑–∏–Ω–æ–≤
**–í orderController.ts –¥–æ–±–∞–≤–ª–µ–Ω–æ:**

```typescript
// –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞–º–∏
...order.items.map(async (orderItem: any) => {
  const product = productsWithStores.find(p => p.id === orderItem.productId);
  if (product) {
    return tx.storeOrderConfirmation.create({
      data: {
        orderItemId: orderItem.id,
        storeId: product.storeId,
        status: 'PENDING'
      }
    });
  }
})
```

### 4. –î–æ–±–∞–≤–ª–µ–Ω—ã Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
**–í orderController.ts –¥–æ–±–∞–≤–ª–µ–Ω–æ:**

```typescript
// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–æ–¥–∞–≤—Ü–∞–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
setImmediate(async () => {
  try {
    await telegramService.sendNewOrderNotifications(result.id);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', error);
  }
});
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ** –æ–ø–µ—Ä–∞—Ü–∏–π –≤–º–µ—Å—Ç–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ
- **–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏** —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ 2-3 —Ä–∞–∑–∞
- **–ú–µ–Ω—å—à–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫** –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### ‚úÖ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:
- **–£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç** –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **Graceful degradation** –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö Telegram
- **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å** –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞–∫–∞–∑–∞

### ‚úÖ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –ø—Ä–æ–¥–∞–≤—Ü–∞–º
- **–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π** —Ç–æ–≤–∞—Ä–æ–≤
- **–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏** –≤ Telegram

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞:
```bash
curl -X POST https://eco-b-6sgyz.ondigitalocean.app/api/orders \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer USER_TOKEN" \
  -d '{
    "items": [
      {"productId": 1, "quantity": 3},
      {"productId": 2, "quantity": 2}
    ],
    "address": "—É–ª. –¢–µ—Å—Ç–æ–≤–∞—è, 123"
  }'
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```json
{
  "success": true,
  "data": {
    "id": 123,
    "userId": 1,
    "address": "—É–ª. –¢–µ—Å—Ç–æ–≤–∞—è, 123",
    "totalAmount": 999.97,
    "status": "NEW",
    "items": [...]
  },
  "message": "–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
- –ü—Ä–æ–¥–∞–≤—Ü—ã –ø–æ–ª—É—á–∞—Ç Telegram —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–∞–º–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
- –ú–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ `/api/stores/my/order-items`

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:
```
‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –∑–∞–∫–∞–∑–∞ #123
üì± –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–æ–¥–∞–≤—Ü—É –≠–∫–æ–ú–∞–≥–∞–∑–∏–Ω (seller123)
```

### –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
- **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 5000+ ms (—Ç–∞–π–º–∞—É—Ç)
- **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 1000-2000 ms (—É—Å–ø–µ—à–Ω–æ)

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∞–π–º–∞—É—Ç–∞:
```typescript
// –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
prisma.$transaction(operations, { timeout: 5000 })

// –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤
prisma.$transaction(operations, { timeout: 15000 })

// –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
prisma.$transaction(operations, { timeout: 30000 })
```

### Environment –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
```bash
# –í .env –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å
PRISMA_TRANSACTION_TIMEOUT=15000
DATABASE_TIMEOUT=30000
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
1. **Connection pooling** - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫ –ë–î
2. **Batch –æ–ø–µ—Ä–∞—Ü–∏–∏** - –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö INSERT
3. **–ò–Ω–¥–µ–∫—Å—ã –ë–î** - –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
4. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
5. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –¥–ª—è –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
```typescript
const startTime = Date.now();
const result = await prisma.$transaction(operations, { timeout: 15000 });
const duration = Date.now() - startTime;
console.log(`–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∑–∞ ${duration}ms`);
```

## –°—Ç–∞—Ç—É—Å
‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –û—à–∏–±–∫–∞ —Ç–∞–π–º–∞—É—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏  
‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–æ:** –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –º–∞–≥–∞–∑–∏–Ω–æ–≤  
‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–æ:** Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è  
‚úÖ **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ:** –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 23 –∏—é–ª—è 2025 –≥.  
**–í–µ—Ä—Å–∏—è:** 2.0  
**–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** Prisma 6.12.0, Node.js 18+
