# Статусы заказов в EcoBazar Backend v2.0

## Обзор обновления

В новой версии системы статусы заказов были упрощены и стандартизированы для повышения удобства использования и понимания процесса заказа.

## Новые статусы заказов

### 1. `NEW` - Новый заказ
- **Описание:** Заказ только что создан покупателем
- **Кто может установить:** Система автоматически при создании заказа
- **Следующий статус:** `WAITING_PAYMENT`

### 2. `WAITING_PAYMENT` - Ожидание оплаты
- **Описание:** Заказ ожидает оплаты от покупателя
- **Кто может установить:** Администратор
- **Следующий статус:** `PREPARING` или `CANCELLED`

### 3. `PREPARING` - Подготовка заказа
- **Описание:** Заказ подготавливается к отправке
- **Кто может установить:** Администратор
- **Следующий статус:** `DELIVERING`
- **Следующий статус:** `DELIVERING` или `CANCELLED`

### 4. `DELIVERING` - Доставляется
- **Описание:** Заказ назначен курьеру и находится в процессе доставки
- **Кто может установить:** Администратор (при назначении курьера)
- **Следующий статус:** `DELIVERED` или `CANCELLED`

### 5. `DELIVERED` - Доставлен
- **Описание:** Заказ успешно доставлен покупателю
- **Кто может установить:** Курьер
- **Финальный статус:** Да

### 6. `CANCELLED` - Отменен
- **Описание:** Заказ отменен администратором или системой
- **Кто может установить:** Администратор
- **Финальный статус:** Да

## Жизненный цикл заказа

```
NEW → WAITING_PAYMENT → PREPARING → DELIVERING → DELIVERED
 ↓         ↓           ↓          ↓
CANCELLED ← CANCELLED ← CANCELLED ← CANCELLED
```

## Удаленные статусы

Следующие статусы были удалены для упрощения системы:
- `PENDING` → заменен на `NEW`
- `CONFIRMED` → заменен на `WAITING_PAYMENT`
- `PREPARING` → удален
- `READY` → удален
- `PROCESSING` → удален
- `SHIPPED` → заменен на `DELIVERING`

## Изменения в API

### Эндпоинты заказов
- `POST /api/orders` - создает заказ со статусом `NEW`
- `PUT /api/orders/:id/status` - обновляет статус (только для админов)
- `GET /api/orders` - фильтрация по новым статусам

### Эндпоинты курьеров
- `GET /api/courier/orders` - получение заказов со статусом `DELIVERING`
- `PUT /api/courier/orders/:id/status` - курьер может установить только `DELIVERED`

## Совместимость

### База данных
- Существующие записи в таблице `OrderStatus` остаются без изменений
- Новые заказы будут использовать только новые статусы
- Старые статусы в историческими данными сохраняются для аналитики

### API
- Все эндпоинты обновлены для работы с новыми статусами
- Валидация запросов обновлена
- Документация API обновлена

## Примеры использования

### Создание заказа
```javascript
// POST /api/orders
{
  "items": [{"productId": 1, "quantity": 2}],
  "address": "ул. Примерная, 123"
}
// Автоматически устанавливается статус: NEW
```

### Обновление статуса администратором
```javascript
// PUT /api/orders/1/status
{
  "status": "WAITING_PAYMENT"
}
```

### Назначение курьера
```javascript
// POST /api/courier/assign
{
  "orderId": 1,
  "courierId": 2
}
// Автоматически устанавливается статус: DELIVERING
```

### Отметка о доставке курьером
```javascript
// PUT /api/courier/orders/1/status
{
  "status": "DELIVERED"
}
```

## Миграция данных

Для существующих заказов рекомендуется:
1. Заказы со статусом `PENDING` → считать как `NEW`
2. Заказы со статусом `CONFIRMED` → считать как `WAITING_PAYMENT`
3. Заказы со статусом `SHIPPED` → считать как `DELIVERING`
4. Остальные статусы остаются без изменений

## Статистика и аналитика

### Активные заказы
- `NEW` + `WAITING_PAYMENT` + `DELIVERING`

### Завершенные заказы
- `DELIVERED` + `CANCELLED`

### Заказы в работе у курьера
- `DELIVERING`

## Техническая реализация

### TypeScript enum
```typescript
export enum OrderStatus {
  NEW = 'NEW',
  WAITING_PAYMENT = 'WAITING_PAYMENT',
  DELIVERING = 'DELIVERING',
  DELIVERED = 'DELIVERED',
  CANCELLED = 'CANCELLED'
}
```

### Валидация Zod
```typescript
const updateOrderStatusSchema = z.object({
  status: z.enum([
    'NEW',
    'WAITING_PAYMENT',
    'DELIVERING',
    'DELIVERED',
    'CANCELLED'
  ])
});
```

## Заключение

Новая система статусов заказов:
- ✅ Упрощена и понятна
- ✅ Покрывает все необходимые этапы
- ✅ Совместима с существующими данными
- ✅ Готова к масштабированию
- ✅ Хорошо документирована

Все изменения применены в коде, документации и готовы к использованию.
